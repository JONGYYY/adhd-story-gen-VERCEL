[phases.setup]
nixPkgs = ["nodejs-20_x", "ffmpeg", "fontconfig", "dejavu_fonts", "chromium"]

[phases.install]
cmds = [
    # Worker uses lightweight deps via railway-package.json
    "bash -lc 'if [ -z \"$UI_SERVICE\" ]; then cp railway-package.json package.json; fi'",
    "npm install --omit=dev"
]

[phases.build]
cmds = [
    # Worker-only step (no-op right now, but reserved for future prebuild)
    "bash -lc 'if [ -z \"$UI_SERVICE\" ]; then echo Worker build; fi'",
    # UI: Build Next.js app when UI_SERVICE is set
    "bash -lc 'if [ -n \"$UI_SERVICE\" ]; then npx next build; fi'"
]

[start]
# If UI_SERVICE is set, start Next UI; otherwise start the worker (Express)
cmd = "bash -lc 'if [ -n \"$UI_SERVICE\" ]; then npx next start -p ${PORT:-3000}; else node railway-backend.js; fi'"

[variables]
NODE_ENV = "production"